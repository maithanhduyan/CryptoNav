# app/nginx.conf
# Định nghĩa upstream cho các server FastAPI
upstream fastapi_app {
    server api:8000;  # 'api' là tên service của FastAPI trong docker-compose (chạy trên cổng 8000)
    # Nếu có nhiều instance app, liệt kê chúng tại đây để Nginx load balance
    # server api2:8000;
}

# Thiết lập vùng lưu cache cho proxy (10 MB, có thể tăng tuỳ nhu cầu)
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=fastapi_cache:10m max_size=100m;

server {
    listen 80;
    server_name _;  # Lắng nghe trên tất cả tên miền (có thể thay bằng domain cụ thể)

    # Proxy tất cả request tới FastAPI
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        # Xác định header cho WebSocket (nếu ứng dụng dùng WebSocket)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Kết nối tới upstream
        proxy_pass http://fastapi_app;

        # Caching: chỉ cache các request GET/HEAD, bỏ qua nếu có Authorization (nội dung cá nhân hoá)
        proxy_cache fastapi_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_valid 200 1m;  # Cache phản hồi HTTP 200 trong 1 phút
        proxy_cache_bypass $http_authorization;  # Bypass cache nếu có header Authorization

        # Thời gian chờ và số lần thử khi proxy
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }

    # (Tùy chọn) Caching cho các nội dung tĩnh nếu có
    # location /static {
    #    alias /app/app/static;
    #    expires 30d;
    # }

    # log
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
